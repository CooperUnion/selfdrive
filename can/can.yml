---

bitrate: 500000

message_templates:
- DBWNodeInfo:
    cycletime: 1000
    signals:
        - gitHash:
            description: Githash of the currently-running firmware.
            width: 32
        - gitDirty:
            description: Repository was dirty at build time.
            width: 1
        - eepromIdentity:
            description: EEPROM identity.
            width: 6

- DBWNodeStatus:
    cycletime: 100

    signals:
      - sysStatus:
          description: Status of the node.
          enumerated_values:
            - UNDEF
            - INIT
            - IDLE
            - ACTIVE
            - LOST_CAN
            - BAD
            - ESTOP
      - requestedSysStatus:
          description: Requested node status.
          enumerated_values:
            - UNDEF
            - INIT
            - IDLE
            - ACTIVE
            - LOST_CAN
            - BAD
            - ESTOP
      - temperature:
          description: Core temperature in Celsius
          width: 7
          offset: 31
      - counter:
          description: Counter for fun.
          width: 8
      - resetReason:
          description: Reset reason.
          enumerated_values:
            - POWERON
            - WATCHDOG_RESET
            - UNKNOWN
      - esp32ResetReasonCode:
          description: ESP32 reset reason code (enum RESET_REASON)
          width: 5

- DBWVelocityCommand:
    cycletime: 10

    signals:
      - brakePercent:
          description: Brake percentage.
          # mimumum: 0.0
          # maximum: 100.0
          unit: percent
          width: 10
          scale: 0.1
      - throttlePercent:
          description: Throttle percentage.
          # minimum: 0.0
          # maximum: 100.0
          unit: percent
          width: 10
          scale: 0.1

- EncoderData:
    cycletime: 10
    signals:
        - encoderLeft:
            description: Left encoder pulses (continuous, bidirectional, and overflowing).
            width: 16
        - encoderRight:
            description: Right encoder pulses (continuous, bidirectional, and overflowing).
            width: 16

nodes:
- BRAKE:
    rx:
    - CTRL_VelocityCommand
    - DBW_ESTOP
    - DBW_VelocityCommand
    - SUP_Authorization
    messages:
    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD2

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE2

    - BrakeData:
          id: 0x11
          cycletime: 100

          signals:
            - dutyCycle:
                description: Brake duty cycle.
                width: 10

            - percent:
                description: Percentage commanded.
                # minimum: 0.0
                # maximum: 100.0
                width: 10
                unit: percent
                scale: 0.1

- CTRL:
    rx:
    - DBW_ESTOP
    - DBW_RawVelocityCommand
    - DBW_VelocityCommand
    messages:
    - Alarms:
        id: 0x22
        cycletime: 10

        signals:
          - alarmsRaised:
              description: Alarms raised
              width: 1
          - speedAlarm:
              description: Speed violation
              width: 1

    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD4

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE4

    - EncoderData:
        from_template: EncoderData
        id: 0x14

    - VelocityCommand:
        from_template: DBWVelocityCommand
        id: 0x20

- DBW:
    messages:
    - ESTOP:
        id: 0x0

        signals:
          - estopReason:
              description: ESTOP reason.
              width: 2
              enumerated_values:
                - MANUAL
                - TIMEOUT
                - INVALID_STATE
                - LIMIT_EXCEEDED
    - InitStrobe:
        id: 0x73

        signals:
          - init:
              description: Flash initial strobe value.
              width: 1


    - RawVelocityCommand:
        from_template: DBWVelocityCommand
        id: 0x667

    - SteeringCommand:
        id: 0x21
        cycletime: 100

        signals:
          - steeringAngleCmd:
              description: Absolute steering angle in radians.
              # minimum: -0.471238898
              # maximum: 0.471238898
              scale: 0.000000001
              # is_signed: true
              width: 32

    - VelocityCommand:
        id: 0x666
        cycletime: 10

        signals:
          - linearVelocity:
              description: Velocity in m/s
              # maximum: 100.0
              scale: 0.1
              width: 10
          # TODO: determine realistic bounds
#         - angularVelocity:
#             description: Velocity in rad/s

- ENCF:
    rx:
    - DBW_ESTOP
    messages:
    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD3

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE3

    - EncoderData:
        from_template: EncoderData
        id: 0x13

- PB:
    rx:
    - DBW_ESTOP
    messages:
    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD5

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE5

    - ParkingBrakeData:
        id: 0x15
        cycletime: 100

        signals:
          - pbSet:
              description: State of the parking brake.
              width: 1

          - magnetEnergized:
              description: State of the parking brake magnet.
              width: 1

          - armedESTOP:
              description: State of the ESTOP arming.
              width: 1

- STEER:
    rx:
      - DBW_ESTOP
    messages:
    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD6

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE6

    - SteeringData:
        id: 0x16
        cycletime: 100

        signals:
          - angle:
              description: Absolute steering angle in radians.
              # minimum: -0.610865238
              # maximum: 0.610865238
              scale: 0.000000001
              twos_complement: true
              width: 32

          - encoderTimeoutSet:
              description: Has the encoder timed out?
              width: 1

          - oDriveConnected:
              description: Is the ODrive connected?
              width: 1

- SUP:
    rx:
      - BRAKE_NodeStatus
      - CTRL_Alarms
      - CTRL_NodeStatus
      - CTRL_VelocityCommand
      - DBW_ESTOP
      - DBW_InitStrobe
      - DBW_RawVelocityCommand
      - DBW_VelocityCommand
      - STEER_NodeStatus
      - THROTTLE_NodeStatus
    messages:
    - Authorization:
        id: 0x1A
        cycletime: 10

        signals:
          - brakeAuthorized:
              description: Brake authorization.
              width: 1
          - throttleAuthorized:
              description: Throttle authorization.
              width: 1
          - steerAuthorized:
              description: Steer authorization.
              width: 1

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0x1B

    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0x1C

- TEST:
    rx: "*"
    messages:
    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD0

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE0

- THROTTLE:
    rx:
    - DBW_ESTOP
    - CTRL_VelocityCommand
    - SUP_Authorization
    messages:
    - NodeInfo:
        from_template: DBWNodeInfo
        id: 0xD1

    - NodeStatus:
        from_template: DBWNodeStatus
        id: 0xE1

    - AccelData:
        id: 0x10
        cycletime: 100

        signals:
          - throttleADutyCycle:
              description: Throttle A duty cycle.
              width: 10

          - throttleFDutyCycle:
              description: Throttle F duty cycle.
              width: 10

          - percent:
              description: Percentage commanded.
              # minimum: 0.0
              # maximum: 100.0
              width: 10
              unit: percent
              scale: 0.1

          - relayState:
              description: Current relay state.
              width: 1

- WHL:
    messages:
    - AbsoluteEncoder:
        id: 0x1E5
        cycletime: 10

        signals:
          - foo:
              description: Foo.
              width: 8

            # TODO: add big endian support to OpenCAN
            #
            # this signal is a signed big-endian value
            # OpenCAN will decode this signal into an unsigned int
            # it is the job of the programmer to re-encode this value
            # into a signed int
          - encoder:
              description: Absolute encoder position.
              width: 16

          - bar:
              description: Bar.
              width: 40
