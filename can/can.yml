---

templategroups:
  dbwnodes:
    - BLINK
    - THROTTLE
    - BRAKE
    - ENCF
    - ENCR
    - PB
    - STEER

messages:
  - NodeStatus:
      id: 0xE0
      cycletime: 100

      template: dbwnodes

      signals:
        - sysStatus:
            description: Status of the node.
            width: 2
            choices:
              - IDLE
              - UNHEALTHY
              - ACTIVE
              - ESTOP
        - counter:
            description: Counter for fun.
            width: 8
        - resetReason:
            description: Reset reason.
            width: 2
            choices:
              - POWERON
              - WATCHDOG_RESET
              - UNKNOWN
        - esp32ResetReasonCode:
            description: ESP32 reset reason code (enum RESET_REASON)
            width: 5

  - NodeInfo:
      id: 0xD0
      cycletime: 1000

      template: dbwnodes

      signals:
        - gitHash:
            description: Githash of the currently-running firmware.
            width: 32
        - gitDirty:
            description: Repository was dirty at build time.
            width: 1
        - eepromIdentity:
            description: EEPROM identity.
            width: 6

  - THROTTLE_AccelData:
      id: 0x10
      cycletime: 100

      signals:
        - throttleACmd:
            description: Throttle A command.
            width: 8
        - throttleFCmd:
            description: Throttle B command.
            width: 8
        - percent:
            description: Percentage commanded.
            width: 8
            unit: percent
        - relayState:
            description: Current relay state.
            width: 1

  - BRAKE_BrakeData:
      id: 0x11
      cycletime: 100

      signals:
        - frequency:
            description: Frequency of PWM input.
            width: 16
            unit: hertz
        - resolution:
            description: Resolution of PWM input.
            width: 16
        - dutyCycle:
            description: Duty Cycle of PWM input.
            width: 16
        - percent:
            description: Percentage commanded.
            width: 8
            unit: percent
        - pressure:
            description: Pressure Sensed.
            width: 8

  - ENCF_EncoderData:
      id: 0x13
      cycletime: 10

      signals:
        - encoderLeft:
            description: Left encoder pulses since last reading.
            is_signed: true
            width: 12
        - encoderRight:
            description: Right encoder pulses since last reading.
            is_signed: true
            width: 12
        - dtUs:
            description: Microseconds since last reading.
            width: 16

  - ENCR_EncoderData:
      id: 0x14
      cycletime: 10

      signals:
        - encoderLeft:
            description: Left encoder pulses since last reading.
            is_signed: true
            width: 12
        - encoderRight:
            description: Right encoder pulses since last reading.
            is_signed: true
            width: 12
        - dtUs:
            description: Microseconds since last reading.
            width: 16

  - PB_ParkingBrakeData:
      id: 0x15
      cycletime: 100

      signals:
        - pbSet:
            description: State of the parking brake.
            width: 1
        - magnetEnergized:
            description: State of the parking brake magnet.
            width: 1
        - armedESTOP:
            description: State of the ESTOP arming.
            width: 1

  - STEER_SteeringData:
      id: 0x16
      cycletime: 100

      signals:
        - angle:
            description: Absolute steering angle in radians.
            minimum: -0.610865238
            maximum: 0.610865238
            scale: 0.000000001
            is_signed: true
            width: 32
        - encoderTimeoutSet:
            description: Has the encoder timed out?
            width: 1
        - oDriveConnected:
            description: Is the ODrive connected?
            width: 1

  - DBW_VelCmd:
      id: 0x20
      cycletime: 100

      signals:
        - throttlePercent:
            description: Throttle percentage.
            maximum: 100
            unit: percent
            width: 7
        - brakePercent:
            description: Brake percentage.
            maximum: 100
            unit: percent
            width: 7

  - STEER_SteeringCmd:
      id: 0x21
      cycletime: 100

      signals:
        - angle:
            description: Absolute steering angle in radians.
            minimum: -0.471238898
            maximum: 0.471238898
            scale: 0.000000001
            is_signed: true
            width: 32

  - WHL_AbsoluteEncoder:
      id: 0x1E5
      cycletime: 10

      signals:
        - foo:
            description: Foo.
            width: 8
        # TODO: add big endian support to gen_dbc.py
        #
        # this signal is a signed big-endian value
        # cantools will decode this signal into an unsigned int
        # it is the job of the programmer to re-encode this value
        # into a signed int
        - encoder:
            description: Absolute encoder position.
            width: 16
        - bar:
            description: Bar.
            width: 40

  - DBW_ESTOP:
      id: 0x41F
      cycletime: 100

      signals:
        - src:
            description: ESTOP source.
            width: 8
            choices:
              - NODE
              - NODESD
              - SAFED
        - reason:
            description: ESTOP reason.
            width: 8
            choices:
              - FAIL
              - TIMEOUT
              - INVALID_STATE
              - LIMIT_EXCEEDED

  - DBW_Active:
      id: 0x420
      cycletime: 100

      signals:
        - active:
            description: DBW is active.
            width: 1

  - DBW_Enable:
      id: 0x421
      cycletime: 100

      signals:
        - enable:
            description: Enable DBW active.
            width: 1

  - DBW_UpdaterUpdateTrigger:
      id: 0x4A0
      cycletime: 100

      template: dbwnodes

      signals:
        - trigger:
            description: Trigger the update.
            width: 1
        - filler1:
            description: Filler.
            width: 7
        - begin:
            description: Begin the update.
            width: 1

  - DBW_UpdaterUpdateData:
      id: 0x4B0
      cycletime: 100

      template: dbwnodes

      signals:
        - position:
            description: Index of 32-bit data chunk.
            width: 24
        - data:
            description: Image data.
            width: 40

  - DBW_NodeUpdateResponse:
      id: 0x4C0
      cycletime: 100

      template: dbwnodes

      signals:
        - ready:
            description: Ready to begin update.
            width: 1

  - DBW_UpdaterUpdateDone:
      id: 0x4D0
      cycletime: 100

      template: dbwnodes

      signals:
        - finalSize:
            description: Number of bytes in final image size.
            width: 32
