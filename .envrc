# .envrc
strict_env
direnv_version '2.32.3'


watch_file './site_scons/env.py'
eval $(./site_scons/env.py --export)


COLOR_MAGENTA="\033[1;35m"

FORMAT_BOLD="\033[1m"
FORMAT_NONE="\033[0m"

MSG_INFO="${FORMAT_BOLD}${COLOR_MAGENTA}info:${FORMAT_NONE}"

msg_info()
{
	printf '%b %s\n' "$MSG_INFO" "$1"
}


use flake


if [ ! -f "$DIRENV_INSTALLED_IDF_TOOLS" ]; then
	msg_info 'installing idf-tools since they seem to be missing'

	invoke deps.idf.install
fi


if [ ! -f "$DIRENV_INSTALLED_SCONS_ESP_IDF_ENVIRONMENT" ]; then
	msg_info 'generating scons esp-idf environment since is seems to be missing'

	invoke deps.idf.scons-env-gen
fi


if [ ! -d "$VIRTUAL_ENV" ]; then
	msg_info "creating \`$VIRTUAL_ENV\` because it doesn't seem to exist"

	invoke deps.python.venv
fi

. "$VIRTUAL_ENV/bin/activate"

if [ ! -f "$DIRENV_INSTALLED_PYTHON_REQUIREMENTS" ]; then
	msg_info 'installing python requirements since they seem to be missing'

	invoke deps.python.install-requirements
fi


PATH_add "$CARGO_HOME/bin"
watch_file './tools/cargo-install-gen.py'

if [ ! -f "$DIRENV_INSTALLED_CRATES" ]; then
	msg_info 'installing rust crates since they seem to be missing'

	invoke deps.cargo.install
fi


pre-commit install
